<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <!-- Add Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <!-- CSS file -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/bs4/dt-1.11.2/datatables.min.css"/>

    <title>APS - Admin Login</title>
  </head>
  <body>

    <div class="container mt-5">
      <div class="row justify-content-center">
        
        <div id="loginScreen" class="col-md-6">
          <image class="img-fluid mb-4" src="Logo.png">


          <div class="card">
            <div class="card-header">
              <h4>Login</h4>
            </div>
            <div class="card-body">
              <form id="#login-form">
                <div class="form-group">
                  <label for="email">Email</label>
                  <input type="email" class="form-control" id="email" required>
                </div>
                <div class="form-group">
                  <label for="password">Password</label>
                  <input type="password" class="form-control" id="password" required>
                </div>
                <button id="submit" type="submit" class="btn btn-primary btn-block">Login</button>
              </form>
            </div>
          </div>
        </div>

        <div id="tableUser" class="d-none container">
          <h1 class="title">Users</h1>
          <hr>
          <button id="logout" class="btn btn-primary mb-4" type="button">Logout</button>

          <table id="userTable" class="table table-striped table-bordered">
            <thead>
              <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              <!-- Add more rows as needed -->
            </tbody>
          </table>  
        </div>

        <div id="tableVehicle" class="d-none container">
          <h1 class="title">Vehicles</h1>
          <hr>
          <button id="vehicleBack" class="btn btn-primary mb-4" type="button">Back</button>
          
          <table id="vehicleTable" class="table table-striped table-bordered">
            <thead>
              <tr>
                <th>Type</th>
                <th>Plate No.</th>
                <th>RFID</th>
              </tr>
            </thead>
            <tbody>
              <!-- Add more rows as needed -->
            </tbody>
          </table>  
        </div>
      </div>
    </div>

    



    <!-- Add Bootstrap JavaScript -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <!-- JavaScript files -->
    <script type="text/javascript" src="https://cdn.datatables.net/v/bs4/dt-1.11.2/datatables.min.js"></script>

    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-analytics.js";
      import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-auth.js";
      import { getDatabase, ref, onValue, set, remove  } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-database.js";

      // TODO: Add SDKs for Firebase products that you want to use
      // https://firebase.google.com/docs/web/setup#available-libraries

      // Your web app's Firebase configuration
      // For Firebase JS SDK v7.20.0 and later, measurementId is optional
      const firebaseConfig = {
        apiKey: "AIzaSyAE0eat83Cl4HPvmqZ-ADqJqiLMfMVaIYo",
        authDomain: "apstest-2c116.firebaseapp.com",
        databaseURL: "https://apstest-2c116-default-rtdb.firebaseio.com",
        projectId: "apstest-2c116",
        storageBucket: "apstest-2c116.appspot.com",
        messagingSenderId: "596540615842",
        appId: "1:596540615842:web:eaa0980be7a8484c317bfb",
        measurementId: "G-EF0G8FQ10Q"
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      const auth = getAuth();
      const database = getDatabase();

      $(document).ready(function() {
          $('#submit').click(function(event) {
            event.preventDefault();
            
            const email = $('#email').val();
            const password = $('#password').val();
            signInWithEmailAndPassword(auth, email, password)
              .then((userCredential) => {
                // Signed in
                const user = userCredential.user;
                console.log(user);



                const users = ref(database, 'users/');
                onValue(users, (snapshot) => {

                  // Hide Login Screen
                  $('#loginScreen').addClass('d-none');
                  
                  // Populate User Table
                  const userDataTable = $('#userTable').DataTable();
                  userDataTable.clear(); // clear the table before adding new rows
                  snapshot.forEach(function(childSnapshot) {
                    const childData = childSnapshot.val();
                    console.log(childData);

                    userDataTable.row.add([childData.name.replaceAll('"', ''), childData.email.replaceAll('"', ''), childData.number.replaceAll('"', ''), '<button class="btn btn-primary" data-id="'+ childData.id.replaceAll('"', '') +'">View Vehicles</button>']);

                  });
                  userDataTable.draw(); // redraw the table with the updated rows
                  $('#tableUser').removeClass('d-none');


                  // Click Logout
                  $('#logout').click(function() {
                    $('#tableUser').addClass('d-none');
                    $('#loginScreen').removeClass('d-none');
                  });

                  // Click View Vehicles
                  $('#userTable tbody').on('click', 'button', function() {
                    var userID = $(this).data('id');
                    
                    const vehicles = ref(database, 'vehicles2/'+userID);
                    onValue(vehicles, (snapshot) => {
                      // Hide UserTable
                      $('#tableUser').addClass('d-none');
                      
                      // Populate Vehicle Table
                      const vehicleDataTable = $('#vehicleTable').DataTable();
                      vehicleDataTable.clear(); // clear the table before adding new rows
                      var vehicleChildData;
                      snapshot.forEach(function(childSnapshot) {
                        vehicleChildData = childSnapshot.val();
                        const childData = vehicleChildData;
                        console.log(childData);

                        vehicleDataTable.row.add([childData.type.replaceAll('"', ''), childData.plateNo.replaceAll('"', ''), '<div class="form-group"><input id="rfid" type="text" class="form-control" value="'+childData.rfid.replaceAll('"', '')+'"><button class="btn btn-success" data-id="'+ childData.id.replaceAll('"', '') +'">Save RFID</button></div>']);

                      });
                      vehicleDataTable.draw(); // redraw the table with the updated rows
                      $('#tableVehicle').removeClass('d-none');


                      // Click Save RFID
                      $('#vehicleTable tbody').on('click', 'button', function() {
                        var vehicleID = $(this).data('id');

                        var rfid = $(this).siblings('#rfid').val();
                        
                        remove(ref(database, 'vehicles/' + vehicleChildData.rfid.replaceAll('"', '')));

                        set(ref(database, 'vehicles2/' + userID + '/' + vehicleID), {
                          id: vehicleID,
                          rfid: rfid,
                          plateNo: vehicleChildData.plateNo.replaceAll('"', ''),
                          type: vehicleChildData.type.replaceAll('"', '')
                        });

                        set(ref(database, 'vehicles/' + rfid), {
                          rfid: rfid,
                          id: vehicleID
                        });
                      });

                      // Click Vehicle Back
                      $('#vehicleBack').click(function() {
                        $('#tableVehicle').addClass('d-none');
                        $('#tableUser').removeClass('d-none');
                      });
                    }); 
                    
                  });
                });


              })
              .catch((error) => {
                const errorCode = error.code;
                const errorMessage = error.message;
                console.log(errorCode, errorMessage);
              });
              
          });
      });
    </script>
  </body>
</html>
